/*
 * myfir.c
 *
 */

#include "myfir.h"

const int16_t lpfCoeff[] =
{
       310,    -20,    -21,    -23,    -25,    -28,    -31,    -35,    -40,    -44,    -48,    -53,    -57,    -60,    -64,    -66,
       -68,    -69,    -68,    -67,    -65,    -61,    -56,    -50,    -43,    -35,    -25,    -15,     -4,      8,     20,     33,
        46,     58,     70,     82,     93,    102,    110,    117,    122,    125,    125,    123,    119,    113,    104,     92,
        78,     62,     44,     23,      1,    -22,    -47,    -72,    -97,   -123,   -148,   -171,   -193,   -213,   -231,   -245,
      -256,   -264,   -266,   -264,   -257,   -245,   -227,   -204,   -175,   -140,    -99,    -53,     -2,     55,    116,    181,
       250,    322,    396,    473,    550,    628,    706,    783,    858,    930,    999,   1063,   1123,   1178,   1226,   1268,
      1303,   1331,   1351,   1363,   1367,   1363,   1351,   1331,   1303,   1268,   1226,   1178,   1123,   1063,    999,    930,
       858,    783,    706,    628,    550,    473,    396,    322,    250,    181,    116,     55,     -2,    -53,    -99,   -140,
      -175,   -204,   -227,   -245,   -257,   -264,   -266,   -264,   -256,   -245,   -231,   -213,   -193,   -171,   -148,   -123,
       -97,    -72,    -47,    -22,      1,     23,     44,     62,     78,     92,    104,    113,    119,    123,    125,    125,
       122,    117,    110,    102,     93,     82,     70,     58,     46,     33,     20,      8,     -4,    -15,    -25,    -35,
       -43,    -50,    -56,    -61,    -65,    -67,    -68,    -69,    -68,    -66,    -64,    -60,    -57,    -53,    -48,    -44,
       -40,    -35,    -31,    -28,    -25,    -23,    -21,    -20,    310,
};

const int16_t hpfCoeff[] =
{
       286,   -136,   -118,   -109,   -104,   -100,    -94,    -85,    -71,    -53,    -31,     -6,     21,     47,     70,     88,
        99,    102,     95,     80,     55,     24,    -12,    -50,    -86,   -117,   -140,   -152,   -151,   -136,   -108,    -68,
       -18,     36,     92,    144,    187,    216,    228,    220,    191,    143,     78,      0,    -84,   -168,   -245,   -305,
      -345,   -356,   -335,   -282,   -198,    -87,     45,    188,    330,    459,    562,    628,    644,    602,    497,    326,
        92,   -200,   -539,   -913,  -1304,  -1696,  -2068,  -2404,  -2684,  -2896,  -3028,  29696,  -3028,  -2896,  -2684,  -2404,
     -2068,  -1696,  -1304,   -913,   -539,   -200,     92,    326,    497,    602,    644,    628,    562,    459,    330,    188,
        45,    -87,   -198,   -282,   -335,   -356,   -345,   -305,   -245,   -168,    -84,      0,     78,    143,    191,    220,
       228,    216,    187,    144,     92,     36,    -18,    -68,   -108,   -136,   -151,   -152,   -140,   -117,    -86,    -50,
       -12,     24,     55,     80,     95,    102,     99,     88,     70,     47,     21,     -6,    -31,    -53,    -71,    -85,
       -94,   -100,   -104,   -109,   -118,   -136,    286,
};

void myfir(const int16_t* input, const int16_t* filterCoeffs, int16_t* output,
           int16_t* delayLine, uint16_t numberOfInputSamples,
           uint16_t numberOfFilterCoeffs)
{
    int i, j, k;
    int32_t sum;

    if(numberOfFilterCoeffs <= 0)
    {
        for (i=0; i < numberOfInputSamples; i++)
            output[i] = input[i];
        return;
    }

    for (i = 0; i < numberOfInputSamples; i++)
    {
        // update delay line with current sample
        for (k = numberOfFilterCoeffs-1; k > 0; k--)
        {
            delayLine[k] = delayLine[k-1];
        }
        delayLine[0] = input[i];
        // Perform filter
        sum = 0;
        for (j = 0; j < numberOfFilterCoeffs; j++)
        {
            // main filter loop y[n] += x[n] * h0 + x[n-1]*h1 + ...
            sum = _smac(sum, delayLine[j], filterCoeffs[j]);
        }
        // update output
        output[i] = _rnd(sum) >> 16;
    }
    return;
}
